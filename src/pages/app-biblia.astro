---
import PageLayout from '../layouts/PageLayout.astro';
---

<PageLayout title="Biblia 365 - Mi Amigo Anhelado">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" is:inline></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;900&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">

  <!-- Aqu√≠ van todos tus estilos is:inline, los dejo iguales porque est√°n perfectos -->
  <style is:inline>
    /* ... (pega aqu√≠ todo tu <style> original, no lo cambio porque est√° brutal) ... */
    /* Para no hacer el mensaje eterno, asumo que mantienes tu CSS tal cual */
  </style>

  <!-- HTML igualito -->
  <div class="main-container">
    <header class="app-header">
      <h1 class="app-title">BIBLIA 365</h1>
      <p class="app-subtitle">Tu Plan Anual de Lectura</p>
      
      <div class="progress-ring">
        <div class="ring-container">
          <svg class="ring-svg" width="120" height="120">
            <defs>
              <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:var(--primary);stop-opacity:1" />
                <stop offset="100%" style="stop-color:var(--accent);stop-opacity:1" />
              </linearGradient>
            </defs>
            <circle class="ring-bg" cx="60" cy="60" r="52" />
            <circle id="ringProgress" class="ring-progress" cx="60" cy="60" r="52"
                    stroke-dasharray="326.73" stroke-dashoffset="326.73" />
          </svg>
          <div class="ring-text">
            <div id="ringDay" class="ring-day">1</div>
            <div class="ring-label">de 365</div>
          </div>
        </div>
        <div class="progress-info">
          <div id="infoDate" class="info-date"></div>
          <div class="info-stats">
            <div class="stat-item">
              <span>üìñ</span>
              <span id="statChapters">0 cap√≠tulos hoy</span>
            </div>
            <div class="stat-item">
              <span>‚ú®</span>
              <span id="statHighlights">0 vers√≠culos resaltados</span>
            </div>
          </div>
        </div>
      </div>
    </header>

    <div class="control-panel">
      <button class="btn-tool" onclick="abrirBiblioteca()">
        <span>üìö</span> Biblioteca
      </button>
      <div class="control-group">
        <button class="btn-tool" onclick="cambiarFuente(-2)">A-</button>
        <button class="btn-tool" onclick="cambiarFuente(2)">A+</button>
      </div>
      <button class="btn-tool" onclick="toggleModo()">
        <span>üåì</span> Tema
      </button>
    </div>

    <div class="search-container" style="display:none;" id="searchContainer">
      <span class="search-icon">üîç</span>
      <input type="text" class="search-input" placeholder="Buscar vers√≠culo o libro..." id="searchInput" />
    </div>

    <div id="contenido"></div>

    <nav class="nav-buttons">
      <button class="btn-nav" onclick="cambiarDia(-1)">‚Üê ANTERIOR</button>
      <button class="btn-nav btn-today" onclick="irAHoy()">HOY</button>
      <button class="btn-nav" onclick="cambiarDia(1)">SIGUIENTE ‚Üí</button>
    </nav>
  </div>

  <!-- Men√∫ flotante, modal, canvas-helper, toast... todo igual -->
  <div id="menuAcciones" class="menu-acciones">
    <!-- ... botones de acciones ... -->
  </div>

  <div id="canvas-helper">
    <!-- ... igual ... -->
  </div>

  <div id="modalBiblioteca" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
      <h2>üìñ Biblioteca Sagrada</h2>
      <div id="gridLibros"></div>
    </div>
  </div>

  <div id="toastContainer"></div>

  <script is:inline>
    const URL_BIBLIA = '/biblia.json';  // ‚Üê ¬°Cambio clave! Local en public/

    let bibleData = null;
    let fechaActual = new Date();
    let fontSize = 21;
    let selectedVersiculo = null;
    let selectedInfo = '';
    let currentVId = null;
    let highlights = JSON.parse(localStorage.getItem('biblia365_highlights') || '{}');

    // booksDB actualizado: usamos hyphens (-) en vez de underscores (_)
    const booksDB = [
      { n: 'G√©nesis', f: 'genesis', c: 50 },
      { n: '√âxodo', f: 'exodo', c: 40 },
      { n: 'Lev√≠tico', f: 'levitico', c: 27 },
      { n: 'N√∫meros', f: 'numeros', c: 36 },
      { n: 'Deuteronomio', f: 'deuteronomio', c: 34 },
      { n: 'Josu√©', f: 'josue', c: 24 },
      { n: 'Jueces', f: 'jueces', c: 21 },
      { n: 'Rut', f: 'rut', c: 4 },
      { n: '1 Samuel', f: '1-samuel', c: 31 },
      { n: '2 Samuel', f: '2-samuel', c: 24 },
      { n: '1 Reyes', f: '1-reyes', c: 22 },
      { n: '2 Reyes', f: '2-reyes', c: 25 },
      { n: '1 Cr√≥nicas', f: '1-cronicas', c: 29 },
      { n: '2 Cr√≥nicas', f: '2-cronicas', c: 36 },
      { n: 'Esdras', f: 'esdras', c: 10 },
      { n: 'Nehem√≠as', f: 'nehemias', c: 13 },
      { n: 'Ester', f: 'ester', c: 10 },
      { n: 'Job', f: 'job', c: 42 },
      { n: 'Salmos', f: 'salmos', c: 150 },
      { n: 'Proverbios', f: 'proverbios', c: 31 },
      { n: 'Eclesiast√©s', f: 'eclesiastes', c: 12 },
      { n: 'Cantares', f: 'cantares', c: 8 },
      { n: 'Isa√≠as', f: 'isaias', c: 66 },
      { n: 'Jerem√≠as', f: 'jeremias', c: 52 },
      { n: 'Lamentaciones', f: 'lamentaciones', c: 5 },
      { n: 'Ezequiel', f: 'ezequiel', c: 48 },
      { n: 'Daniel', f: 'daniel', c: 12 },
      { n: 'Oseas', f: 'oseas', c: 14 },
      { n: 'Joel', f: 'joel', c: 3 },
      { n: 'Am√≥s', f: 'amos', c: 9 },
      { n: 'Abd√≠as', f: 'abdias', c: 1 },
      { n: 'Jon√°s', f: 'jonas', c: 4 },
      { n: 'Miqueas', f: 'miqueas', c: 7 },
      { n: 'Nah√∫m', f: 'nahum', c: 3 },
      { n: 'Habacuc', f: 'habacuc', c: 3 },
      { n: 'Sofon√≠as', f: 'sofonias', c: 3 },
      { n: 'Hageo', f: 'hageo', c: 2 },
      { n: 'Zacar√≠as', f: 'zacarias', c: 14 },
      { n: 'Malaqu√≠as', f: 'malaquias', c: 4 },
      { n: 'Mateo', f: 'mateo', c: 28 },
      { n: 'Marcos', f: 'marcos', c: 16 },
      { n: 'Lucas', f: 'lucas', c: 24 },
      { n: 'Juan', f: 'juan', c: 21 },
      { n: 'Hechos', f: 'hechos', c: 28 },
      { n: 'Romanos', f: 'romanos', c: 16 },
      { n: '1 Corintios', f: '1-corintios', c: 16 },
      { n: '2 Corintios', f: '2-corintios', c: 13 },
      { n: 'G√°latas', f: 'galatas', c: 6 },
      { n: 'Efesios', f: 'efesios', c: 6 },
      { n: 'Filipenses', f: 'filipenses', c: 4 },
      { n: 'Colosenses', f: 'colosenses', c: 4 },
      { n: '1 Tesalonicenses', f: '1-tesalonicenses', c: 5 },
      { n: '2 Tesalonicenses', f: '2-tesalonicenses', c: 3 },
      { n: '1 Timoteo', f: '1-timoteo', c: 6 },
      { n: '2 Timoteo', f: '2-timoteo', c: 4 },
      { n: 'Tito', f: 'tito', c: 3 },
      { n: 'Filem√≥n', f: 'filemon', c: 1 },
      { n: 'Hebreos', f: 'hebreos', c: 13 },
      { n: 'Santiago', f: 'santiago', c: 5 },
      { n: '1 Pedro', f: '1-pedro', c: 5 },
      { n: '2 Pedro', f: '2-pedro', c: 3 },
      { n: '1 Juan', f: '1-juan', c: 5 },
      { n: '2 Juan', f: '2-juan', c: 1 },
      { n: '3 Juan', f: '3-juan', c: 1 },
      { n: 'Judas', f: 'judas', c: 1 },
      { n: 'Apocalipsis', f: 'apocalipsis', c: 22 },
    ];

    let plan = [];
    booksDB.forEach(b => {
      for (let i = 1; i <= b.c; i++) {
        plan.push({ n: b.n, f: b.f, c: i });
      }
    });

    // Toast (igual)
    function showToast(message, icon = '‚úì') {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.innerHTML = `<span class="toast-icon">${icon}</span><span class="toast-message">${message}</span>`;
      document.body.appendChild(toast);
      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 400);
      }, 3000);
    }

    // Progress ring (igual)
    function updateProgressRing(day) {
      const circumference = 326.73;
      const progress = (day / 365) * circumference;
      document.getElementById('ringProgress').style.strokeDashoffset = circumference - progress;
      document.getElementById('ringDay').textContent = day;
    }

    function updateStats(chaptersCount) {
      const highlightCount = Object.keys(highlights).length;
      document.getElementById('statChapters').textContent = `${chaptersCount} ${chaptersCount === 1 ? 'cap√≠tulo' : 'cap√≠tulos'} hoy`;
      document.getElementById('statHighlights').textContent = `${highlightCount} ${highlightCount === 1 ? 'vers√≠culo resaltado' : 'vers√≠culos resaltados'}`;
    }

    async function cargarLectura(custom = null) {
      if (!bibleData) {
        try {
          const res = await fetch(URL_BIBLIA);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          bibleData = await res.json();
          document.getElementById('gridLibros').innerHTML = booksDB
            .map(l => `<button onclick="seleccionarLibro('${l.f}','${l.n}')">${l.n}</button>`)
            .join('');
          showToast('Biblia cargada exitosamente', 'üìñ');
        } catch (err) {
          console.error('Error cargando biblia.json:', err);
          showToast('No se pudo cargar la Biblia üòî Revisa consola', '‚ö†Ô∏è');
          document.getElementById('contenido').innerHTML = '<p style="text-align:center; color:red; padding:2rem;">Error al cargar la Biblia. Verifica que biblia.json est√© en /public/</p>';
          return;
        }
      }

      const start = new Date(fechaActual.getFullYear(), 0, 0);
      const dayOfYear = Math.floor((fechaActual - start) / 86400000) + 1;
      updateProgressRing(dayOfYear);

      const dateStr = fechaActual.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      document.getElementById('infoDate').textContent = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);

      const lectura = custom || plan.slice(
        Math.floor(((dayOfYear - 1) * 1189) / 365),
        Math.floor((dayOfYear * 1189) / 365)
      );

      updateStats(lectura.length);

      let html = '';
      for (const it of lectura) {
        // Normalizamos la clave: lowercase + hyphen si aplica
        let clave = it.f.toLowerCase();

        let cap = null;
        if (bibleData[clave] && bibleData[clave][String(it.c)]) {
          cap = bibleData[clave][String(it.c)];
        }

        // Si no, intentamos variantes comunes
        if (!cap) {
          const variantes = [
            clave.replace(/-/g, ''),           // 1samuel
            clave.replace(/-/g, '_'),          // 1_samuel (por si acaso)
            clave,                             // ya est√°
          ];
          for (const varClave of variantes) {
            if (bibleData[varClave] && bibleData[varClave][String(it.c)]) {
              cap = bibleData[varClave][String(it.c)];
              console.log(`Encontrado con variante: ${varClave}`);
              break;
            }
          }
        }

        if (!cap) {
          console.warn(`Cap√≠tulo no encontrado: ${it.n} ${it.c} (clave: ${clave})`);
          html += `<details class="capitulo-acordeon"><summary class="header-info"><h2>${it.n} ${it.c} (no disponible)</h2></summary></details>`;
          continue;
        }

        html += `
          <details ${lectura.indexOf(it) === 0 ? 'open' : ''} class="capitulo-acordeon">
            <summary class="header-info">
              <h2>${it.n} ${it.c} <span class="chapter-badge">${Object.keys(cap).length} v.</span></h2>
              <span>‚ñº</span>
            </summary>
            <div class="versiculos">
              ${Object.entries(cap).map(([num, texto]) => {
                const vId = `${it.f}_${it.c}_${num}`;
                const highlightClass = highlights[vId] || '';
                const textoLimpio = (texto || '')
                  .replace(/_/g, '')
                  .replace(/\\n/g, ' ')
                  .replace(/\/n/g, ' ')
                  .replace(/\n/g, ' ')
                  .replace(/\s+/g, ' ')
                  .trim();

                return `
                  <div class="versiculo" onclick="activarMenu(this, '${it.n} ${it.c}:${num}', '${vId}')">
                    <span class="num">${num}</span>
                    <span class="txt ${highlightClass}">${textoLimpio}</span>
                  </div>
                `;
              }).join('')}
            </div>
          </details>
        `;
      }

      document.getElementById('contenido').innerHTML = html;
    }

    // Resto de funciones (activarMenu, subrayar, generarImagen, etc.) se mantienen iguales
    // ... pega aqu√≠ todas las dem√°s funciones window.XXXXX que ten√≠as ...

    // Inicializaci√≥n
    if (localStorage.getItem('biblia365_darkmode') === 'true') {
      document.body.classList.add('dark-mode');
    }
    const savedFont = localStorage.getItem('biblia365_fontsize');
    if (savedFont) {
      fontSize = parseInt(savedFont);
      document.querySelectorAll('.versiculos').forEach(v => v.style.fontSize = fontSize + 'px');
    }

    cargarLectura();  // ¬°Arranca!
  </script>
</PageLayout>

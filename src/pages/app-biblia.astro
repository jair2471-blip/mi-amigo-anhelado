---
import PageLayout from '../layouts/PageLayout.astro';
---

<PageLayout title="Biblia 365 - Mi Amigo Anhelado">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Crimson+Text:wght@400;600&display=swap" rel="stylesheet">

  <style is:inline>
    :root {
      --primary: #1a4d2e; --accent: #d4a574; --bg: #faf8f5; --text: #1a202c; --surface: #ffffff; --border: rgba(0,0,0,0.1);
    }
    body.dark-mode {
      --bg: #0a0e0d; --text: #f7fafc; --surface: #1a1f1e; --primary: #52b788; --border: rgba(255,255,255,0.1);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background-color: var(--bg); color: var(--text); font-family: 'Crimson Text', serif; transition: 0.3s; min-height: 100vh; }
    
    .main-container { max-width: 800px; margin: 0 auto; padding: 20px; }
    
    .app-header { text-align: center; padding: 20px 0; }
    .progress-container { position: relative; width: 90px; height: 90px; margin: 0 auto; }
    .ring-bg { fill: none; stroke: var(--border); stroke-width: 7; }
    .ring-active { fill: none; stroke: var(--accent); stroke-width: 7; stroke-linecap: round; transform: rotate(-90deg); transform-origin: 50% 50%; transition: 1s; }

    .panel { 
      position: sticky; top: 10px; background: var(--surface); 
      padding: 12px; border-radius: 15px; display: flex; 
      justify-content: space-between; z-index: 100; border: 1px solid var(--border);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 20px;
    }
    button { padding: 10px 15px; border: none; border-radius: 8px; background: var(--primary); color: white; cursor: pointer; font-weight: bold; }
    button:active { transform: scale(0.95); }

    /* Modal Biblioteca */
    #modalBiblioteca { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; place-items: center; z-index: 1000; padding: 20px; }
    .modal-content { background: var(--bg); width: 100%; max-width: 700px; padding: 25px; border-radius: 20px; max-height: 90vh; overflow-y: auto; }
    .seccion-titulo { margin: 20px 0 10px; border-bottom: 2px solid var(--accent); font-family: 'Playfair Display'; color: var(--primary); }
    .grid-libros { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
    .btn-lib { background: var(--surface); color: var(--text); border: 1px solid var(--border); padding: 10px 5px; font-size: 0.8rem; }

    /* Estilos de Lectura */
    .card { background: var(--surface); border-radius: 15px; padding: 25px; margin-bottom: 30px; border: 1px solid var(--border); }
    .v-num { color: var(--accent); font-weight: bold; margin-right: 8px; font-size: 0.85em; }
    .txt-v { font-size: var(--f-size, 20px); line-height: 1.8; margin-bottom: 15px; }
    .cap-titulo { font-family: 'Playfair Display'; font-size: 2rem; color: var(--primary); margin-bottom: 20px; text-align: center; }

    .nav-footer { display: flex; gap: 10px; margin-top: 30px; padding-bottom: 60px; }
    .btn-nav { flex: 1; padding: 15px; }
  </style>

  <div class="main-container">
    <div class="app-header">
      <h1 style="font-family: 'Playfair Display'; font-size: 2.2rem; color: var(--primary);">BIBLIA 365</h1>
      <div class="progress-container">
        <svg width="90" height="90">
          <circle class="ring-bg" cx="45" cy="45" r="38" />
          <circle id="progreso" class="ring-active" cx="45" cy="45" r="38" stroke-dasharray="238.7" stroke-dashoffset="238.7" />
        </svg>
        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);">
          <span id="diaLabel" style="font-weight:bold; font-size:1.2rem;">1</span>
        </div>
      </div>
    </div>

    <div class="panel">
      <button onclick="window.abrirLibros()">üìö Biblioteca</button>
      <div style="display:flex; gap:8px;">
        <button onclick="window.zoom(-2)">A-</button>
        <button onclick="window.zoom(2)">A+</button>
        <button onclick="window.modoNoche()">üåì</button>
      </div>
    </div>

    <div id="lector">
      <p style="text-align:center; padding: 50px;">Iniciando...</p>
    </div>

    <div class="nav-footer">
      <button class="btn-nav" onclick="window.irDia(-1)">Anterior</button>
      <button class="btn-nav" onclick="window.irHoy()">Hoy</button>
      <button class="btn-nav" onclick="window.irDia(1)">Siguiente</button>
    </div>
  </div>

  <div id="modalBiblioteca" onclick="if(event.target==this) window.cerrarLibros()">
    <div class="modal-content">
      <h2 style="text-align:center; font-family: 'Playfair Display';">√çndice</h2>
      <h3 class="seccion-titulo">Antiguo Testamento</h3>
      <div id="listaAT" class="grid-libros"></div>
      <h3 class="seccion-titulo">Nuevo Testamento</h3>
      <div id="listaNT" class="grid-libros"></div>
      <button onclick="window.cerrarLibros()" style="width:100%; margin-top:30px; background:var(--accent)">Regresar</button>
    </div>
  </div>

  <script is:inline>
    // 1. Datos y Configuraci√≥n
    const ESTRUCTURA = [
      {n:'G√©nesis', f:'genesis', c:50, t:'AT'}, {n:'√âxodo', f:'exodo', c:40, t:'AT'}, {n:'Lev√≠tico', f:'levitico', c:27, t:'AT'},
      {n:'N√∫meros', f:'numeros', c:36, t:'AT'}, {n:'Deuteronomio', f:'deuteronomio', c:34, t:'AT'}, {n:'Josu√©', f:'josue', c:24, t:'AT'},
      {n:'Jueces', f:'jueces', c:21, t:'AT'}, {n:'Rut', f:'rut', c:4, t:'AT'}, {n:'1 Samuel', f:'1_samuel', c:31, t:'AT'},
      {n:'2 Samuel', f:'2_samuel', c:24, t:'AT'}, {n:'1 Reyes', f:'1_reyes', c:22, t:'AT'}, {n:'2 Reyes', f:'2_reyes', c:25, t:'AT'},
      {n:'1 Cr√≥nicas', f:'1_cronicas', c:29, t:'AT'}, {n:'2 Cr√≥nicas', f:'2_cronicas', c:36, t:'AT'}, {n:'Esdras', f:'esdras', c:10, t:'AT'},
      {n:'Nehem√≠as', f:'nehemias', c:13, t:'AT'}, {n:'Ester', f:'ester', c:10, t:'AT'}, {n:'Job', f:'job', c:42, t:'AT'},
      {n:'Salmos', f:'salmos', c:150, t:'AT'}, {n:'Proverbios', f:'proverbios', c:31, t:'AT'}, {n:'Eclesiast√©s', f:'eclesiastes', c:12, t:'AT'},
      {n:'Cantares', f:'cantares', c:8, t:'AT'}, {n:'Isa√≠as', f:'isaias', c:66, t:'AT'}, {n:'Jerem√≠as', f:'jeremias', c:52, t:'AT'},
      {n:'Lamentaciones', f:'lamentaciones', c:5, t:'AT'}, {n:'Ezequiel', f:'ezequiel', c:48, t:'AT'}, {n:'Daniel', f:'daniel', c:12, t:'AT'},
      {n:'Oseas', f:'oseas', c:14, t:'AT'}, {n:'Joel', f:'joel', c:3, t:'AT'}, {n:'Am√≥s', f:'amos', c:9, t:'AT'},
      {n:'Abd√≠as', f:'abdias', c:1, t:'AT'}, {n:'Jon√°s', f:'jonas', c:4, t:'AT'}, {n:'Miqueas', f:'miqueas', c:7, t:'AT'},
      {n:'Nah√∫m', f:'nahum', c:3, t:'AT'}, {n:'Habacuc', f:'habacuc', c:3, t:'AT'}, {n:'Sofon√≠as', f:'sofonias', c:3, t:'AT'},
      {n:'Hageo', f:'hageo', c:2, t:'AT'}, {n:'Zacar√≠as', f:'zacarias', c:14, t:'AT'}, {n:'Malaqu√≠as', f:'malaquias', c:4, t:'AT'},
      {n:'Mateo', f:'mateo', c:28, t:'NT'}, {n:'Marcos', f:'marcos', c:16, t:'NT'}, {n:'Lucas', f:'lucas', c:24, t:'NT'},
      {n:'Juan', f:'juan', c:21, t:'NT'}, {n:'Hechos', f:'hechos', c:28, t:'NT'}, {n:'Romanos', f:'romanos', c:16, t:'NT'},
      {n:'1 Corintios', f:'1_corintios', c:16, t:'NT'}, {n:'2 Corintios', f:'2_corintios', c:13, t:'NT'}, {n:'G√°latas', f:'galatas', c:6, t:'NT'},
      {n:'Efesios', f:'efesios', c:6, t:'NT'}, {n:'Filipenses', f:'filipenses', c:4, t:'NT'}, {n:'Colosenses', f:'colosenses', c:4, t:'NT'},
      {n:'1 Tesalonicenses', f:'1_tesalonicenses', c:5, t:'NT'}, {n:'2 Tesalonicenses', f:'2_tesalonicenses', c:3, t:'NT'},
      {n:'1 Timoteo', f:'1_timoteo', c:6, t:'NT'}, {n:'2 Timoteo', f:'2_timoteo', c:4, t:'NT'}, {n:'Tito', f:'tito', c:3, t:'NT'},
      {n:'Filem√≥n', f:'filemon', c:1, t:'NT'}, {n:'Hebreos', f:'hebreos', c:13, t:'NT'}, {n:'Santiago', f:'santiago', c:5, t:'NT'},
      {n:'1 Pedro', f:'1_pedro', c:5, t:'NT'}, {n:'2 Pedro', f:'2_pedro', c:3, t:'NT'}, {n:'1 Juan', f:'1_juan', c:5, t:'NT'},
      {n:'2 Juan', f:'2_juan', c:1, t:'NT'}, {n:'3 Juan', f:'3_juan', c:1, t:'NT'}, {n:'Judas', f:'judas', c:1, t:'NT'},
      {n:'Apocalipsis', f:'apocalipsis', c:22, t:'NT'}
    ];

    let bibliaJSON = null;
    let fecha = new Date();
    let fontSize = 20;
    let plan = [];
    ESTRUCTURA.forEach(b => { for(let i=1; i<=b.c; i++) plan.push({n:b.n, f:b.f, c:i}); });

    // 2. Funciones Vitales (Carga y B√∫squeda)
    async function cargarBiblia() {
      const lector = document.getElementById('lector');
      try {
        const res = await fetch('/biblia.json'); 
        if (!res.ok) throw new Error("No se encontr√≥ biblia.json en /public");
        bibliaJSON = await res.json();
        window.iniciarApp();
      } catch (e) {
        lector.innerHTML = `<div class="card" style="color:red; text-align:center"><h3>Error de carga</h3><p>${e.message}</p></div>`;
      }
    }

    function buscarLibro(nombre) {
      if (!bibliaJSON) return null;
      if (bibliaJSON[nombre]) return bibliaJSON[nombre];
      const keys = Object.keys(bibliaJSON);
      const encontrada = keys.find(k => k.toLowerCase().includes(nombre.toLowerCase()) || nombre.toLowerCase().includes(k.toLowerCase()));
      return encontrada ? bibliaJSON[encontrada] : null;
    }

    window.iniciarApp = () => {
      const inicio = new Date(fecha.getFullYear(), 0, 0);
      const diaAnio = Math.floor((fecha - inicio) / 86400000);
      const idx = (diaAnio - 1) * 3;
      const hoyItems = plan.slice(idx, idx + 3);

      document.getElementById('diaLabel').innerText = diaAnio;
      const offset = 238.7 - (diaAnio / 365) * 238.7;
      document.getElementById('progreso').style.strokeDashoffset = offset;

      renderLectura(hoyItems);
    };

    function renderLectura(items) {
      const lector = document.getElementById('lector');
      let html = '';
      items.forEach(it => {
        const libroData = buscarLibro(it.n);
        const capData = libroData ? libroData[it.c] : null;
        if (capData) {
          html += `<div class="card"><h2 class="cap-titulo">${it.n} ${it.c}</h2><div>`;
          Object.entries(capData).forEach(([num, texto]) => {
            const numReal = isNaN(num) ? num : (parseInt(num) + (Array.isArray(capData) ? 1 : 0));
            let tLimpio = texto.replace(new RegExp('^' + numReal + '/n'), '').replace(/^\d+\/n/, '').replace(/\/n/g, '<br>');
            html += `<p class="txt-v"><span class="v-num">${numReal}</span>${tLimpio}</p>`;
          });
          html += `</div></div>`;
        }
      });
      lector.innerHTML = html || '<p style="text-align:center">Contenido no disponible.</p>';
      window.scrollTo(0,0);
    }

    // 3. Funciones de Botones (Atadas a window)
    window.abrirLibros = () => {
      document.getElementById('listaAT').innerHTML = ESTRUCTURA.filter(b => b.t === 'AT').map(b => `<button class="btn-lib" onclick="window.seleccionarLibro('${b.f}', '${b.n}')">${b.n}</button>`).join('');
      document.getElementById('listaNT').innerHTML = ESTRUCTURA.filter(b => b.t === 'NT').map(b => `<button class="btn-lib" onclick="window.seleccionarLibro('${b.f}', '${b.n}')">${b.n}</button>`).join('');
      document.getElementById('modalBiblioteca').style.display = 'grid';
    };

    window.cerrarLibros = () => document.getElementById('modalBiblioteca').style.display = 'none';

    window.seleccionarLibro = (f, n) => {
      const libro = ESTRUCTURA.find(l => l.f === f);
      let caps = [];
      for(let i = 1; i <= libro.c; i++) caps.push({ f, n, c: i });
      window.cerrarLibros();
      renderLectura(caps);
    };

    window.zoom = (n) => {
      fontSize += n;
      document.documentElement.style.setProperty('--f-size', fontSize + 'px');
    };

    window.modoNoche = () => document.body.classList.toggle('dark-mode');
    window.irDia = (d) => { fecha.setDate(fecha.getDate() + d); window.iniciarApp(); };
    window.irHoy = () => { fecha = new Date(); window.iniciarApp(); };

    // Iniciar
    document.addEventListener('DOMContentLoaded', cargarBiblia);
  </script>
</PageLayout>
